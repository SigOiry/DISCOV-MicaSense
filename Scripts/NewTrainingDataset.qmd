---
title: "Create a New Training Dataset"
author: "Simon Oiry"
format: html
---

```{r library}
library(tidyverse)
library(terra)
library(sf)
```

```{r list of files}
### Path of the new training dataset that will be created
output_name <- "Data/Training/DISCOV_RGB_Belon.txt"

### Path of the image from which pixels will be extracted to create the new training dataset

trainging_shp <- c("Data/shp/Training/Training_DISCOV_RGB.shp") %>% 
  as_tibble() %>% 
  rename(path = "value") %>% 
  mutate(filename = gsub(".*/","",path))

img_path <- "Data/img/Belon_RGB_04122024.tif"

trainging_shp$imgpath <- img_path
```

```{r taining dataset building}


for(i in 1:nrow(trainging_shp)){
  
  shp <- read_sf(trainging_shp$path[i])
  rast <- rast(trainging_shp$imgpath[i])
  
  
  Class <-data.frame(Class = unique(shp$Class),
                ID= c(1:length( unique(shp$Class))))
  
  shp <- shp %>% 
    left_join(Class, by= "Class") %>% 
    vect()
  
  shp_rast <- rasterize(shp, rast, field = "ID") 
  
  stk <- rast(list(rast, shp_rast)) %>% 
    terra::crop(shp, mask = T) %>% 
    as.data.frame() %>% 
    dplyr::filter(!is.na(ID)) %>% 
    left_join(Class, by = "ID") %>% 
    mutate(ID = c(1:nrow(.))) %>% 
    set_names(c("Red",
                "Green",
                "Blue",
                "Alpha",
                "ID",
                "True_Class"))
  
  std <- stk %>%
    pivot_longer(-c(True_Class,ID), names_to = "Band", values_to = "Ref") %>% 
    group_by(ID) %>% 
    reframe(STD = (Ref-min(Ref))/(max(Ref)-min(Ref)),
            Band = Band) %>%
    pivot_wider(names_from = Band,
                values_from = STD)  %>% 
    set_names(c('ID',
                'Reflectance_Stan_444',
                  'Reflectance_Stan_475',
                  'Reflectance_Stan_531',
                  'Reflectance_Stan_560',
                  'Reflectance_Stan_650',
                  'Reflectance_Stan_668',
                  'Reflectance_Stan_705',
                  'Reflectance_Stan_717',
                  'Reflectance_Stan_740',
                  'Reflectance_Stan_842'))
  
  
  
  df <- stk %>% 
    left_join(std, by = "ID") %>% 
    select(-ID) %>% 
    mutate(NDVI_Stan = (Reflectance_Stan_842-Reflectance_Stan_668)/(Reflectance_Stan_842+Reflectance_Stan_668),
           NDVI = (Reflectance_842-Reflectance_668)/(Reflectance_842+Reflectance_668)) %>% 
    relocate(True_Class) 
  
  if(i == 1){
    df_new <- df
  }else{
    df_new <- rbind(df_new,df)
  }
  rm(df)
  rm(std)
  rm(stk)
}

new_training_data <- rbind(df_new,old_data)



```

